<?xml version="1.0" encoding="UTF-8"?>
<api context="/api/v1/games" name="ChessGames" xmlns="http://ws.apache.org/ns/synapse">
    <resource methods="GET" uri-template="/">
        <inSequence>
            <call description="Fetch Chess Game Players">
                <endpoint key="fetchChessPlayers" />
            </call>
            <payloadFactory media-type="json" template-type="default">
                <format>$1</format>
                <args>
                    <arg expression="$.players" evaluator="json" />
                </args>
            </payloadFactory>
            <enrich description="">
                <source clone="true" type="body" />
                <target action="replace" type="property" property="transformedResponse" />
            </enrich>
            <script language="js"><![CDATA[var responsePayload = JSON.parse(mc.getProperty("transformedResponse"));
var characters = 'abcdefghijklmnopqrstuvwxyz';
var randomChar = characters.charAt(Math.floor(Math.random() * characters.length));
var filteredResponse = null;
for (var i = 0; i < responsePayload.length; i++) {
   if (responsePayload[i].startsWith(randomChar)) {
       filteredResponse = responsePayload[i];
       break;
   }
}
if (filteredResponse != null) {
   mc.setPayloadJSON(filteredResponse);
} else {
   mc.setPayloadJSON("");
}
filteredResponse = filteredResponse.replace(/"/g, '');
mc.setProperty("filteredResponse", filteredResponse);
mc.setProperty("filteredResponseType", typeof filteredResponse);]]></script>
            <log category="INFO" level="custom">
                <property name="selectedPlayer" expression="get-property('filteredResponse')" />
                <property name="selectedPlayerType"
                    expression="get-property('filteredResponseType')" />
            </log>
            <property name="uri.var.username" scope="default" type="STRING"
                expression="fn:concat('', get-property('filteredResponse'))" />
            <log category="INFO" level="custom">
                <property name="selectedPlayerUsername"
                    expression="get-property('uri.var.username')" />
            </log>
            <log category="INFO" level="custom">
                <property name="playerSummaryUrl"
                    expression="fn:concat('https://api.chess.com/pub/player/', get-property('uri.var.username'), '/stats')" />
            </log>
            <call>
                <endpoint>
                    <http method="GET"
                        uri-template="https://api.chess.com/pub/player/{uri.var.username}/stats" />
                </endpoint>
            </call>
            <respond description="Player Summary" />
        </inSequence>
        <faultSequence>
        </faultSequence>
    </resource>
</api>